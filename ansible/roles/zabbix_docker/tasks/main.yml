---
# roles/zabbix_docker/tasks/main.yml

- name: Install prerequisite packages
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: present
    update_cache: true

- name: Add Docker GPG key
  ansible.builtin.apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg
    state: present

- name: Add Docker apt repository
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
    state: present
    filename: docker

- name: Install Docker CE and Compose plugin (v2)
  ansible.builtin.apt:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin
    state: present
    update_cache: true

- name: Ensure Docker daemon is enabled and running
  ansible.builtin.systemd:
    name: docker
    enabled: true
    state: started

- name: Create Zabbix stack directory
  ansible.builtin.file:
    path: "{{ zabbix_stack_dir }}"
    state: directory
    mode: "0755"

- name: Create schema staging directory
  ansible.builtin.file:
    path: "{{ zabbix_stack_dir }}/schema"
    state: directory
    mode: "0755"

- name: Create nginx config directory (for proxy container)
  ansible.builtin.file:
    path: "{{ zabbix_stack_dir }}/nginx"
    state: directory
    mode: "0755"
  when: zabbix_enable_proxy | bool

- name: Ensure TLS directory exists on target (proxy)
  ansible.builtin.file:
    path: "{{ zabbix_tls_target_dir }}"
    state: directory
    mode: "0755"
  when: zabbix_enable_proxy | bool

# NOTE: copy always reads from control machine and writes to remote
# Do NOT delegate_to localhost.
- name: Push wildcard fullchain.pem from control machine to target
  ansible.builtin.copy:
    src: "{{ zabbix_tls_local_fullchain }}"
    dest: "{{ zabbix_tls_cert_path }}"
    mode: "0644"
  when:
    - zabbix_enable_proxy | bool
    - zabbix_tls_ship_from_control | bool

- name: Push wildcard privkey.pem from control machine to target
  ansible.builtin.copy:
    src: "{{ zabbix_tls_local_privkey }}"
    dest: "{{ zabbix_tls_key_path }}"
    mode: "0600"
  when:
    - zabbix_enable_proxy | bool
    - zabbix_tls_ship_from_control | bool

- name: Render nginx.conf (for proxy container)
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: "{{ zabbix_stack_dir }}/nginx/nginx.conf"
    mode: "0644"
  when: zabbix_enable_proxy | bool

- name: Render docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ zabbix_compose_file }}"
    mode: "0644"

# --- DB bootstrap sequence ---

- name: Start DB only
  ansible.builtin.command:
    cmd: >
      docker compose -f "{{ zabbix_compose_file }}" up -d db
  changed_when: true

- name: Wait for MySQL to be ready inside DB container
  ansible.builtin.command:
    cmd: >
      docker compose -f "{{ zabbix_compose_file }}" exec -T db
      mysqladmin ping
      -uroot -p"{{ zabbix_db_root_password }}"
      --silent
  register: mysql_ping
  retries: "{{ zabbix_mysql_ping_retries | default(60) }}"
  delay: "{{ zabbix_mysql_ping_delay | default(2) }}"
  until: mysql_ping.rc == 0
  changed_when: false

- name: Pull schema image (so schema extraction is stable)
  ansible.builtin.command:
    cmd: docker pull "{{ zabbix_schema_image }}"
  changed_when: false

- name: Extract create.sql.gz from schema image to host
  ansible.builtin.shell: |
    set -euo pipefail
    CID="$(docker create "{{ zabbix_schema_image }}")"
    docker cp "${CID}:{{ zabbix_schema_file_in_image }}" "{{ zabbix_stack_dir }}/schema/create.sql.gz"
    docker rm -f "${CID}" >/dev/null
    gzip -dc "{{ zabbix_stack_dir }}/schema/create.sql.gz" > "{{ zabbix_stack_dir }}/schema/create.sql"
  args:
    executable: /bin/bash
    creates: "{{ zabbix_stack_dir }}/schema/create.sql"
  changed_when: true

- name: Check if Zabbix users table exists
  ansible.builtin.command:
    cmd: >
      docker compose -f "{{ zabbix_compose_file }}" exec -T db
      mysql -h 127.0.0.1
      -uroot -p"{{ zabbix_db_root_password }}"
      -N -B
      "{{ zabbix_db_name }}"
      -e "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='{{ zabbix_db_name }}' AND table_name='users';"
  register: users_table_exists
  changed_when: false

- name: Check users row count (if table exists)
  ansible.builtin.command:
    cmd: >
      docker compose -f "{{ zabbix_compose_file }}" exec -T db
      mysql -h 127.0.0.1
      -uroot -p"{{ zabbix_db_root_password }}"
      -N -B
      "{{ zabbix_db_name }}"
      -e "SELECT COUNT(*) FROM users;"
  register: users_row_count
  changed_when: false
  when: users_table_exists.stdout | trim == "1"

- name: Import Zabbix schema from host file (only if needed)
  ansible.builtin.shell: |
    set -euo pipefail
    docker compose -f "{{ zabbix_compose_file }}" exec -T db \
      mysql -h 127.0.0.1 -uroot -p"{{ zabbix_db_root_password }}" "{{ zabbix_db_name }}" \
      < "{{ zabbix_stack_dir }}/schema/create.sql"
  args:
    executable: /bin/bash
  when: users_table_exists.stdout | trim != "1" or (users_row_count.stdout | default("0") | trim | int) == 0
  changed_when: true

- name: Verify users/config rows after import
  ansible.builtin.command:
    cmd: >
      docker compose -f "{{ zabbix_compose_file }}" exec -T db
      mysql -h 127.0.0.1
      -uroot -p"{{ zabbix_db_root_password }}"
      -N -B
      "{{ zabbix_db_name }}"
      -e "SELECT (SELECT COUNT(*) FROM users) AS users_count, (SELECT COUNT(*) FROM config) AS config_count;"
  register: post_import_counts
  changed_when: false

- name: Fail if DB still looks unbootstrapped
  ansible.builtin.fail:
    msg: "Zabbix DB still not bootstrapped: {{ post_import_counts.stdout }}"
  when: >
    (post_import_counts.stdout is not defined) or
    ((post_import_counts.stdout.split()[0] | int) == 0) or
    ((post_import_counts.stdout.split()[1] | int) == 0)

# --- Bring up the rest of the stack ---

- name: Start Zabbix services (server + web + proxy)
  ansible.builtin.command:
    cmd: >
      docker compose -f "{{ zabbix_compose_file }}" up -d
  changed_when: true

- name: Wait for Zabbix web container healthcheck
  ansible.builtin.command:
    cmd: >
      docker compose -f "{{ zabbix_compose_file }}" ps --format json
  register: compose_ps_json
  retries: "{{ zabbix_http_wait_retries | default(60) }}"
  delay: "{{ zabbix_http_wait_delay | default(2) }}"
  until: compose_ps_json.rc == 0
  changed_when: false

- name: Wait for Zabbix UI to respond (HTTPS via FQDN) from control machine
  ansible.builtin.uri:
    url: "https://{{ zabbix_fqdn }}/"
    status_code: [200, 302]
    return_content: false
    validate_certs: true
  delegate_to: localhost
  become: false
  register: zbx_ui_https_check
  retries: "{{ zabbix_http_wait_retries | default(60) }}"
  delay: "{{ zabbix_http_wait_delay | default(2) }}"
  until: zbx_ui_https_check.status is defined
  changed_when: false